$("body").prepend("<div id='note-announce'></div>");var noteAnnounce=function(e){$("<div class='note-announce'></div>").prependTo("#note-announce").css({opacity:0,marginBottom:"-60px"}).html(e).animate({opacity:1,marginBottom:"30px"}).delay(1e4).fadeOut(800,function(){$(this).remove()})};noteAnnounce("<b>Note Initialized</b>");var getUrlVars=function(){var e={};return window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,i,n){e[i]=n}),e};setTimeout(function(){if(void 0!==getUrlVars().note){var e=getUrlVars().note;"fil"==e.substring(0,3)?(e=e.substring(4,e.length),noteAnnounce("<b>file successfully uploaded</b> "+noteDirectory+"uploads/"+e)):"err"==e.substring(0,3)?(e=e.substring(4,e.length),noteAnnounce("<b>file upload error</b><br/> "+e)):"mes"==e.substring(0,3)&&(e=e.substring(4,e.length),noteAnnounce(e))}},500);var srcNodes=["img","iframe","source"],hrefNodes=["a","link"],editAdjust=function(e,t){var i=e.value.length;120>=i?e.style.fontSize="18px":i>120&&190>=i?e.style.fontSize="16px":i>190&&(e.style.fontSize="14px",t=!1),t?(e.style.height="1px",e.style.height=e.scrollHeight+62+"px"):(e.style.overflow="auto",e.style.height="240px")},getBlockId=function(e){for(var t=$(e).attr("class").split(/\s+/),i="",n=0;n<t.length;n++)t[n].indexOf("note-block_")>-1&&(i=t[n]);return i},getNoteElement=function(e){return $(".note."+$(e).attr("id"))},isInit=!1,isHidden=!1,makeClasses=function(){var e=1,t=1;$(".note").each(function(){$(this).hasClass("post")?-1==$(this).attr("class").indexOf("note-block_")&&($(this).addClass("note-block_"+e),$(this).find(".note").each(function(){$(this).addClass("note-block_"+e+"_"+t),t++}),t=1):-1==$(this).attr("class").indexOf("note-block_")?$(this).addClass("note-block_"+e):e--,e++})},makeHighlights=function(){$(".note").each(function(){if(getBlockId(this).split("_").length-1<=1){var e="";e=$(this).hasClass("post")?"<div class='note-highlight note-comp'></div>":"<div class='note-highlight'></div>",$(e).appendTo("body").css({top:$(this).offset().top-10,left:$(this).offset().left-10,width:$(this).width()+20,height:$(this).height()+20}).attr("id",getBlockId(this)).mouseenter(function(){$(this).clearQueue().animate({opacity:.4},200)}).mouseout(function(){$(this).clearQueue().animate({opacity:.5},200)}).attr("data-method","update")}})},fadeOutLeft=function(e){$(".note-edit#"+e).animate({opacity:0,left:"-=20px"},200,function(){$(".note-edit#"+e).css({left:"+=20px",display:"none",opacity:.9})}),$(".note-edit-arrow#"+e).animate({opacity:0,left:"-=20px"},200,function(){$(".note-edit-arrow#"+e).css({left:"+=20px",display:"none",opacity:.9})})},fadeOutRight=function(e){$(".note-edit#"+e).animate({opacity:0,left:"+=20px"},200,function(){$(".note-edit#"+e).css({left:"-=20px",display:"none",opacity:.9})}),$(".note-edit-arrow#"+e).animate({opacity:0,left:"+=20px"},200,function(){$(".note-edit-arrow#"+e).css({left:"-=20px",display:"none",opacity:.9})})},makeToolbar=function(e,t){var i=function(e){$(e).hasClass("note-selected")?($(e).parent().find(".note-toolbar-delete").removeClass("note-selected"),$(e).parent().find(".note-toolbar-copy").removeClass("note-selected"),$(e).parent().find(".note-toolbar-upload").removeClass("note-selected"),$(".note-highlight#"+$(e).parent().attr("id")).attr("data-method","update")):($(e).parent().find(".note-toolbar-delete").removeClass("note-selected"),$(e).parent().find(".note-toolbar-copy").removeClass("note-selected"),$(e).parent().find(".note-toolbar-upload").removeClass("note-selected"),$(".note-highlight#"+$(e).parent().attr("id")).attr("data-method",$(e).attr("data-newmethod")),$(e).addClass("note-selected"))},n=function(e){if($(e).hasClass("note-selected"))$(e).parent().find("form").remove(),i(e);else{var t=$("<form class='note-upload' method='POST' enctype='multipart/form-data' action='"+noteDirectory+"upload.php'></form>").insertBefore(e);$(t).append("<input value='104857600' name='MAX_FILE_SIZE'>"),$(t).append("<input value='"+location.protocol+"//"+location.host+location.pathname+"' name='pagelocation'>"),$(t).append("<input value='"+noteDirectory+"' name='noteDirectory'>"),$("<input type='file' name='uploadfile'>").appendTo(t).click().change(function(){i($(".note-toolbar-upload.note-selected")),i(e)})}};if(0==t){var o=$(e).attr("id"),a=$("<div class='note-toolbar' id='"+o+"'></div>");a.insertAfter(e).css({top:$(".note-edit#"+o).offset().top,left:$(".note-edit#"+o).offset().left+260}).fadeIn(),$("<div data-newmethod='delete' title='Delete Block' class='note-toolbar-delete'></div>").appendTo(a).fadeIn().click(function(){i(this)}),$("<div data-newmethod='copy' title='Copy Block' class='note-toolbar-copy'></div>").appendTo(a).fadeIn().click(function(){i(this)}),$("<div data-newmethod='upload' title='Upload File' class='note-toolbar-upload'></div>").appendTo(a).fadeIn().click(function(){n(this)})}else{var a=$("<div class='note-toolbar' id='"+t[0].substring(0,t[0].lastIndexOf("_"))+"'></div>");a.insertAfter(e).css({top:$(".note-edit#"+t[0]).offset().top,left:$(".note-edit#"+t[0]).offset().left+260}).fadeIn(),$("<div title='Next Block' class='note-toolbar-right'></div>").appendTo(a).fadeIn().click(function(){for(var t=$(e).attr("data-childarray").split(","),i=0,n=!0;n;)"block"==$(".note-edit#"+t[i]).css("display")&&(i==t.length-1?(fadeOutRight(t[i]),$(".note-edit#"+t[0]).fadeIn().focus(),$(".note-edit-arrow#"+t[0]).fadeIn(),n=!1):(fadeOutRight(t[i]),$(".note-edit#"+t[i+1]).fadeIn().focus(),$(".note-edit-arrow#"+t[i+1]).fadeIn(),n=!1)),i++}),$("<div title='Previous Block' class='note-toolbar-left'></div>").appendTo(a).fadeIn().click(function(){for(var t=$(e).attr("data-childarray").split(","),i=0,n=!0;n;)"block"==$(".note-edit#"+t[i]).css("display")&&(0==i?(fadeOutLeft(t[i]),$(".note-edit#"+t[t.length-1]).fadeIn().focus(),$(".note-edit-arrow#"+t[t.length-1]).fadeIn(),n=!1):(fadeOutLeft(t[i]),$(".note-edit#"+t[i-1]).fadeIn().focus(),$(".note-edit-arrow#"+t[i-1]).fadeIn(),n=!1)),i++}),$("<div data-newmethod='delete' title='Delete Block' class='note-toolbar-delete'></div>").appendTo(a).fadeIn().click(function(){i(this)}),$("<div data-newmethod='copy' title='Copy Block' class='note-toolbar-copy'></div>").appendTo(a).fadeIn().click(function(){i(this)}),$("<div data-newmethod='upload' title='Upload File' class='note-toolbar-upload'></div>").appendTo(a).fadeIn().click(function(){n(this)})}},fadeOutPostEdits=function(e){$(".note-edit").each(function(){$(this).attr("id").indexOf($(e).attr("id"))>=0&&($(this).fadeOut(),$(".note-edit-arrow#"+$(this).attr("id")).fadeOut())})},convertContent=function(e){return e=void 0==e?"":e.replace(/<br\s*\/?>/gm,"\n").replace(/</g,"[").replace(/>/g,"]")},makeInput=function(e){$(".note-highlight").each(function(){fadeOutPostEdits(this),$(".note-toolbar#"+$(this).attr("id")).fadeOut()});var t=!1;if(0!==$(".note-toolbar#"+$(e).attr("id")).length&&(t=!0),t)"block"==$(".note-toolbar#"+$(e).attr("id")).css("display")?(fadeOutPostEdits(e),$(".note-toolbar#"+$(e).attr("id")).fadeOut()):"none"==$(".note-toolbar#"+$(e).attr("id")).css("display")&&0!==$(".note-edit#"+$(e).attr("id")+"_1").length?($(".note-edit#"+$(e).attr("id")+"_1").fadeIn().focus(),$(".note-edit-arrow#"+$(e).attr("id")+"_1").fadeIn(),$(".note-toolbar#"+$(e).attr("id")).fadeIn()):"none"==$(".note-toolbar#"+$(e).attr("id")).css("display")&&($(".note-edit#"+$(e).attr("id")).fadeIn().focus(),$(".note-edit-arrow#"+$(e).attr("id")).fadeIn(),$(".note-toolbar#"+$(e).attr("id")).fadeIn());else{var i=$(e).offset(),n=0,o=0,a=0,s=0,r=!0,l="inherit",c=[];if(getNoteElement(e).hasClass("post"))getNoteElement(e).find(".note").each(function(){var t=$(this).get(0).nodeName.toLowerCase(),d="";d=srcNodes.indexOf(t)>=0?$(this).attr("src"):hrefNodes.indexOf(t)>=0?$(this).attr("href"):$(this).html(),c.push(getBlockId(this)),d=convertContent(d),$(document).height()-(i.top+$(e).height())<280&&i.top>=280?(r=!1,l="240px",n=i.top-280,o=i.left+($(e).width()-240)/2,a=i.top,s=i.left+($(e).width()-240)/2+100):(n=i.top+$(e).height()+40,o=i.left+($(e).width()-240)/2,a=i.top+$(e).height()+40,s=i.left+($(e).width()-240)/2+100),$("<textarea onkeyup='editAdjust(this, "+r+")' id='"+getBlockId(this)+"' class='note-edit'></textarea>").insertAfter(e).css({top:n,left:o,height:l}).html(d).focus(function(){editAdjust(this,r)}),r?$("<div id='"+getBlockId(this)+"' class='note-edit-arrow'></div>").insertAfter(".note-edit#"+getBlockId(this)).css({top:a,left:s}):$("<div id='"+getBlockId(this)+"' class='note-edit-arrow bottom'></div>").insertAfter(".note-edit#"+getBlockId(this)).css({top:a,left:s})}),$(e).attr("data-childarray",c),$(".note-edit#"+c[0]).fadeIn(function(){makeToolbar(e,c)}).focus(),$(".note-edit-arrow#"+c[0]).fadeIn();else{var d=getNoteElement(e).get(0).nodeName.toLowerCase(),u="";u=srcNodes.indexOf(d)>=0?getNoteElement(e).attr("src"):hrefNodes.indexOf(d)>=0?getNoteElement(e).attr("href"):getNoteElement(e).html(),u=convertContent(u),$(document).height()-(i.top+$(e).height())<280&&i.top>=280?(r=!1,l="240px",n=i.top-280,o=i.left+($(e).width()-240)/2,a=i.top,s=i.left+($(e).width()-240)/2+100):(n=i.top+$(e).height()+40,o=i.left+($(e).width()-240)/2,a=i.top+$(e).height()+40,s=i.left+($(e).width()-240)/2+100),$("<textarea onkeyup='editAdjust(this, "+r+")' id='"+$(e).attr("id")+"' class='note-edit'></textarea>").insertAfter(e).css({top:n,left:o,height:l}).html(u).focus(function(){editAdjust(this,r)}).fadeIn(function(){makeToolbar(e,!1)}).focus(),r?$("<div id='"+$(e).attr("id")+"' class='note-edit-arrow'></div>").insertAfter(".note-edit#"+$(e).attr("id")).css({top:a,left:s}).fadeIn():$("<div id='"+$(e).attr("id")+"' class='note-edit-arrow bottom'></div>").insertAfter(".note-edit#"+$(e).attr("id")).css({top:a,left:s}).fadeIn()}}},callNote=function(){isInit||isHidden?isInit&&isHidden?($(".note-highlight").each(function(){$(this).fadeIn()}),isHidden=!1):!isHidden&&isInit&&($(".note-highlight").each(function(){$(this).stop().fadeOut()}),$(".note-edit").each(function(){$(this).stop().fadeOut(function(){$(this).remove()})}),$(".note-edit-arrow").each(function(){$(this).stop().fadeOut(function(){$(this).remove()})}),$(".note-toolbar").each(function(){$(this).stop().fadeOut(function(){$(this).remove()})}),isHidden=!0):(makeClasses(),makeHighlights(),$(".note-highlight").click(function(){makeInput(this)}),$(".note-highlight").each(function(){$(this).fadeIn()}),isInit=!0,isHidden=!1)},revertContent=function(e){return e=void 0==e?"":e.replace(/\n/g,"[br/]").replace(/\</g,"&lt;").replace(/\>/g,"&gt;").replace(/\[/g,"<").replace(/\]/g,">")},saveNote=function(){var e=!1;if(!isHidden&&isInit){isInit=!1;var t={filepath:filePath,filename:fileName,blocks:[]};$(".note-highlight").each(function(){if(0!==$(".note-edit#"+$(this).attr("id")).length||0!==$(".note-edit#"+$(this).attr("id")+"_1").length){var i=getNoteElement(this);if($(this).hasClass("note-comp")){var n=$(this).attr("data-method"),o={id:$(this).attr("id"),method:n,blocks:[]},a=$(this).attr("data-childarray").split(",");switch(n){case"update":for(var s=0;s<a.length;s++){var r=$(".note-edit#"+a[s]).val();r=revertContent(r);var l=$(".note."+a[s]).get(0).nodeName.toLowerCase(),c={id:$(".note-edit#"+a[s]).attr("id"),content:r,node:l};o.blocks.push(c),srcNodes.indexOf(l)>=0?$(".note."+a[s]).attr("src",r):hrefNodes.indexOf(l)>=0?$(".note."+a[s]).attr("href",r):$(".note."+a[s]).html(r)}break;case"delete":i.remove();break;case"copy":i.clone().insertAfter(i),e=!0}t.blocks.push(o)}else{var l=i.get(0).nodeName.toLowerCase(),r=$(".note-edit#"+$(this).attr("id")).val();r=revertContent(r);var n=$(this).attr("data-method"),o={id:$(this).attr("id"),method:n,content:r,node:l};switch(n){case"update":srcNodes.indexOf(l)>=0?i.attr("src",r):hrefNodes.indexOf(l)>=0?i.attr("href",r):i.html(r);break;case"delete":i.remove();break;case"copy":i.clone().insertAfter(i),e=!0}t.blocks.push(o)}}}),$.ajax({url:noteDirectory+"update.php",type:"POST",data:t,success:function(i){noteAnnounce(i),e&&$(".note").each(function(){for(var e=$(this).attr("class"),t=e.split(" "),i=[],n=0;n<t.length;n++)t[n].indexOf("note-block_")<0&&i.push(t[n]);$(this).attr("class",i.join(" "))});for(var n=0;n<t.blocks.length;n++)"upload"===t.blocks[n].method&&$(".note-toolbar#"+t.blocks[n].id+" form").submit();$(".note-edit").each(function(){$(this).fadeOut(function(){$(this).remove()}),$(".note-edit-arrow#"+$(this).attr("id")).fadeOut(function(){$(this).remove()})}),$(".note-highlight").each(function(){$(this).stop().fadeOut(function(){$(this).remove()}),$(".note-toolbar#"+$(this).attr("id")).fadeOut(function(){$(this).remove()})})}})}},logOut=function(){};shortcut.remove("Ctrl+E"),shortcut.remove("Meta+E"),shortcut.add("Ctrl+E",function(){callNote()}),shortcut.add("Ctrl+S",function(){saveNote()}),shortcut.add("Meta+E",function(){callNote()}),shortcut.add("Meta+S",function(){saveNote()});